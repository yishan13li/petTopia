<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>活動管理</title>
<link rel="icon" type="image/png" sizes="16x16"
	th:href="@{/admin_static/images/favicon.png}">
<link th:href="@{/admin_static/css/style.css}" rel="stylesheet">
<link rel="stylesheet"
	th:href="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css}">
<link rel="stylesheet"
	th:href="@{https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.css}">
<style type="text/css">
.container {
	max-width: 95%; /* 調整容器寬度 */
}

.imgact {
	width: 150px;
	height: 150px;
	object-fit: cover;
	border-radius: 5px;
}

.floating-button {
	position: fixed;
	bottom: 20px;
	right: 20px;
	width: 60px;
	height: 60px;
	background-color: #007bff;
	color: white;
	border: none;
	border-radius: 50%;
	font-size: 30px;
	text-align: center;
	line-height: 60px;
	box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
	cursor: pointer;
}

td.dt-type-numeric {
	text-align: center !important; /* 讓所有數字欄位也置中 */
}

th.dt-type-numeric {
	text-align: left !important; /* 讓所有數字欄位也置中 */
}

td.pending {
	color: red;
}

td.approved {
	color: green;
}
</style>
</head>

<body>

	<!--**********************************
        Main wrapper start
    ***********************************-->
	<div id="main-wrapper">

		<div th:replace="~{layout/vendor_admin_header}"></div>

		<div class="content-body">
			<div class="container mt-2">
				<select id="eventFilter" class="form-select">
					<option value="all">顯示全部</option>
					<option value="ongoing">顯示進行中</option>
					<option value="ended">顯示已結束</option>
				</select>
				<button class="floating-button" onclick="openAddEventModal()">+</button>
				<table id="eventTable"
					class="table table-bordered table-hover text-center">
					<thead class="table-primary">
						<tr>
							<th>活動圖片</th>
							<th>活動名稱</th>
							<th>活動時間</th>
							<th>地點</th>
							<th>狀態</th>
							<th>瀏覽人數</th>
							<th>操作</th>
						</tr>
					</thead>
					<tbody id="eventTableBody">

					</tbody>
				</table>
			</div>
			<!--**********************************
            Footer start
        ***********************************-->

		</div>
	</div>



	<script th:src="@{/admin_static/vendor/chartist/js/chartist.min.js}"></script>

	<script th:src="@{/admin_static/vendor/moment/moment.min.js}"></script>
	<script th:src="@{https://code.jquery.com/jquery-3.6.0.min.js}"></script>
	<script
		th:src="@{https://cdn.datatables.net/2.2.2/js/dataTables.min.js}"></script>

	<script>
	axios({
	    method: 'get',
	    url: 'http://localhost:8080/api/vendor/activity/1'
	})
	.then(response => {
	    console.log(response.data);
	    let data = response.data;

	    // 篩選條件選擇器
	    const eventFilter = document.getElementById("eventFilter");

	    // 根據篩選條件過濾活動
	    eventFilter.addEventListener("change", function() {
	        let filterValue = eventFilter.value;
	        let filteredData = data.filter(event => {
	            let currentDate = new Date();

	            if (filterValue === "ongoing") {
	                return new Date(event.startTime) >= currentDate && new Date(event.endTime) >= currentDate;
	            } else if (filterValue === "ended") {
	                return new Date(event.endTime) < currentDate;
	            } else {
	                return true; // 顯示所有活動
	            }
	        });

	        // 更新 DataTable 資料
	        updateEventTable(filteredData);
	    });

	    // 初始顯示所有活動
	    eventFilter.dispatchEvent(new Event("change"));

	})
	.catch(error => {
	    console.error('Error fetching events:', error);
	});

	// 更新表格資料
	function updateEventTable(filteredData) {
    let table = $('#eventTable').DataTable(); // 獲取已初始化的 DataTable 實例
    table.clear(); // 清空現有資料

    // 遍歷篩選後的資料，並添加進表格
    filteredData.forEach(event => {
    	// 針對每個活動，發送請求來獲取圖片 ID
        axios({
            method: 'get',
            url: `http://localhost:8080/photos/ids?vendorActivityId=${event.id}`
        })
        .then(response => {
            let imageIds = response.data;

            let firstImageUrl = '';
            if (imageIds && imageIds.length > 0) {
                let firstImageId = imageIds[0];
                firstImageUrl = `http://localhost:8080/photos/download?photoId=${firstImageId}`;
            }

            // 構造表格行
            let row = [
                `<img src="${firstImageUrl}" class="img-fluid rounded imgact" alt="活動圖片">`,
                event.name,
                `${formatDate(event.startTime)} - ${formatDate(event.endTime)}`,
                event.address,
                `<td class="${event.status === '審核中' ? 'pending' : 'approved'}">${event.status}</td>`,
                event.numberVisitor,
                `<button class="btn btn-danger btn-sm" onclick="deleteRow(event, this, ${event.id})">刪除</button>`
            ];

            table.row.add(row); // 添加新資料行
            table.draw(); // 重新繪製表格
        })
        .catch(error => {
            console.error('Error fetching image IDs for activity:', error);
        });
    });
}

	// 格式化日期
	function formatDate(dateString) {
	    let date = new Date(dateString);
	    return date.toLocaleDateString("zh-TW") + " " + date.toLocaleTimeString("zh-TW", { hour: '2-digit', minute: '2-digit' });
	}

	// 刪除活動
	function deleteRow(event, button, activityId) {
	    event.stopPropagation(); // 防止觸發 goToDetails()
	    if (confirm("確定要刪除這個活動嗎？")) {
	        axios.delete(`/api/vendor-activity/${activityId}`)
	            .then(() => {
	                let row = button.closest("tr");
	                row.remove();
	            })
	            .catch(error => {
	                console.error('Error deleting activity:', error);
	            });
	    }
	}

	// 點擊行進入活動詳細頁面
	function goToDetails(activityId) {
	    window.location.href = `/vendor-activity-details.html?id=${activityId}`;
	}
    
  
    

        function openAddEventModal() {
            // 在這裡添加你的新增活動邏輯，例如顯示表單或開啟彈出視窗
            alert("新增活動視窗開啟");
        }
        $('#example').DataTable({
            columnDefs: [
                { targets: 4, type: "string" } // 強制這一欄當作字串處理
            ]
        });
        
      
    </script>

	<script
		th:src="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js}"></script>
</body>

</html>
